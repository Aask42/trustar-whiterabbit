<html>
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="http://neo4j-contrib.github.io/developer-resources/language-guides/assets/css/main.css">
    <title>WhiteRabbit</title>
</head>

<body>
<div role="navigation" class="navbar navbar-default navbar-static-top">
    <div class="container">
        <div class="row">
            <div class="col-sm-6 col-md-6">
                <ul class="nav navbar-nav">
                    <li>
                        <form role="search" class="navbar-form" id="search">
                            <div class="form-group">
                                <input type="text" value="Locky" placeholder="Search Malware Family" class="form-control" name="search">
                            </div>
                            <button class="btn btn-default" type="submit">Search</button>
                        </form>
                    </li>
                </ul>
            </div>
            <div class="navbar-header col-sm-6 col-md-6">
                <div class="navbar-brand">
                    <div class="brand">WhiteRabbit</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-5">
        <div class="panel panel-default">
            <div class="panel-heading">Malware Families</div>
            <div class="row">
                <div class="col-md-12 col-sm-12">
                    <ul id="families">
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-7">
        <div class="panel panel-default">
            <div class="panel-heading" id="malware"></div>
            <div class="row">
                <div class="col-md-12 col-sm-12" style="display:inline; height:800px">
                    <div id="graph"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<style>
.links line {
  stroke: #999;
  stroke-opacity: 0.6;
}


.nodes circle:hover {
  fill: #000;
}

</style>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script type="text/javascript" src="//code.jquery.com/jquery-1.11.0.min.js"></script>

<script type="text/javascript">
    var graphDiv = document.getElementById("graph");
    var svg = d3.select("div #graph").append("svg");
    var query=$("#search").find("input[name=search]").val();

    function render() {

        $("svg").empty();
        var width = 800;
        var height = 600;
        svg
            .attr("width", width)
            .attr("height", height)
            .attr("fill", "#000");

        var color = d3.scaleOrdinal(d3.schemeCategory20);

        var simulation = d3.forceSimulation()
            .force("link", d3.forceLink().id(function(d) { return d.id; }))
            .force("collide",d3.forceCollide( function(d){return d.r + 8 }).iterations(16) )
            .force("charge", d3.forceManyBody())
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("y", d3.forceY(0))
            .force("x", d3.forceX(0));

        d3.json(`/graph/${query}`, function(error, graph) {
            if (error) throw error;

            var link = svg.append("g")
            .attr("class", "links")
            .selectAll("line")
            .data(graph.links)
            .enter().append("line")
            .attr("stroke-width", function(d) { return Math.sqrt(d.value); });

        var node = svg.append("g")
            .attr("class", "nodes")
            .selectAll("circle")
            .data(graph.nodes)
            .enter()
            .append("circle")
            .attr("r", 5)
            .attr("fill", function(d) { return color(d.group); })
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));

        node
            .append("text")
            .attr("dy", ".35em")
            .text(function(d) { return d.id; });

        simulation
            .nodes(graph.nodes)
            .on("tick", ticked);

        simulation.force("link")
            .links(graph.links);

        function ticked() {
            link
                .attr("x1", function(d) { return d.source.x; })
                .attr("y1", function(d) { return d.source.y; })
                .attr("x2", function(d) { return d.target.x; })
                .attr("y2", function(d) { return d.target.y; });

            node
                .attr("cx", function(d) { return d.x; })
                .attr("cy", function(d) { return d.y; });
            }
        });

        function dragstarted(d) {
            if (!d3.event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(d) {
            d.fx = d3.event.x;
            d.fy = d3.event.y;
        }

        function dragended(d) {
            if (!d3.event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

    }
</script>

<script type="text/javascript">
    $(function () {
        function showMalware(family) {
            $.get("/malware/" + encodeURIComponent(family),
                    function (data) {
                        if (!data) return;
                        $("#malware").text("Explore " + data.family);
                        var $list = $("#seeds").empty();
                        data.seeds.forEach(function (seed) {
                            $list.append($("<li>" + seed.address + "</li>"));
                        });
                    }, "json");
            return false;
        }
        function search() {
            var query=$("#search").find("input[name=search]").val();
            $.get("/search?q=" + encodeURIComponent(query),
                    function (data) {
                        var t = $("table#results tbody").empty();
                        if (!data || data.length == 0) return;
                        data.forEach(function (results) {
                            $("<tr><td class='malware'>" + results.family + "</td></tr>").appendTo(t)
                                    .click(function() { showMalware($(this).find("td.malware").text());})
                        });
                        showMalware(data[0].family);
                    }, "json");
            return false;
        }
        $("#search").submit(search);
        search();
        render();
    })
</script>

<script type="text/javascript">
    $(function () {
        function showMalwareFamilies(family) {
            $.get("/malware",
                    function (data) {
                        if (!data) return;
                        var $list = $("#families").empty();
                        data.malwareFamilies.forEach(function (malware) {
                            $list.append($("<li>" + malware.family + "</li>"));
                        });
                    }, "json");
            return false;
        }
        showMalwareFamilies();
    })
</script>

</body>
</html>